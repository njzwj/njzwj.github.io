---
title: "凯利判据和风险控制"
date: "2025-03-12T20:00:00Z"
excerpt: ""
coverImage: "/assets/hero/galaxy.webp"
---

凯利公式讲述了这样一个情境：有个赌徒通过电话传来的内幕消息赌马。可惜内幕消息不太可靠，可能是听不清楚，也可能是内幕不靠谱。总而言之，他只有$p$的几率获胜，赔率是$b$，也就是说投入1块钱本金，输光本金或者赢回$b$块钱。他应该如何分配自己的资金避免亏损？

50年代，约翰拉里凯利提出了凯利公式。它被用于计算最大化结果期望的资本比例：$f=\frac{bp-q}{b}$，其中$q=1-p$。

但是凯利公式的缺陷是要么赢回$b$的钱，要么输掉本金。在有止损的交易中不实用。那么考虑凯利公式的扩展情况，也就是每场赌局最多亏5%，但是赢了可以10%（止盈离场），那么应该投入多少的资金进入以最大化长期收益呢？

不失一般性，假设初始资金为1，$f$表示投入资金。盈利情况得到$1+fb$的资金，亏损情况得到$1-fc$资金。在5\%止损，10\%套利离场的情况下，$b=0.1$，$c=0.05$。下表列出了盈亏2种情况：

| 概率 | 损益 |
| --- | --- |
| $p$ | $1+fb$ |
| $q$ | $1-fc$ |

最大化对数期望

$$E=p\log(1+fb)+q\log(1-fc)$$

也就是

对$f$求导：

$$
\frac{dE}{df}=\frac{pb}{1+fb}-\frac{qc}{1-fc}
$$

令其为0，可得

$$
\frac{pb}{1+fb}=\frac{qc}{1-fc}
$$

整理得到，

$$
f = \frac{p}{c} - \frac{q}{b}
$$

我们称它为扩展凯利公式，用于计算本金不会亏损完的情况。

假设在一场50%几率认为收益10%是可实现的场景，并且设定5%止损，有$p=q=0.5$，$b=0.1$，$c=0.05$。

$$
f=5
$$

凯利公式居然让我们加5倍杠杆进行投资！

在这轮投资中，最好情况是拿到10%盈利离场，那么有50%总仓位的收益。看起来还不错？但是如果发生了5%的亏损呢？总仓位会发生25%的回撤。这还是不考虑杠杆的情况。显然对于50%胜率的操作，重仓会带来巨大的账户波动，并且放弃掉绝大多数市场机遇。此外，账户经历数次25%的回撤就很难再盈利。

通过观察凯利公式，我们可以观察到简化仓位模型的陷阱：

1. 安全边界过低，风险过大。持仓开始时，波动远大于盈利，容易被甩出策略，平仓止损。
2. 容易高估盈利：没有考虑过情况变化导致的10\%收益预期或许会无法到来。

如果要将凯利公式运用到投资中，不得不考虑的问题有：

1. 合理的波动率，不能够影响投资者持仓心理。
2. 合理的杠杆率，可以进行适当分散仓位投资。
3. 合理的亏损和安全边界：杠杆导致安全边界过差，亏损期望随着盈利期望一致扩大。
4. 合理的止损线：止损线过高会导致波动平仓，使得50\%几率盈利失效。

凯利公式的启示也很简单，亏损是决定你投资的最重要因素。一切投资决策都由亏损决定。例如对亏损的看法，认识，承受能力等。

1. 止损线决定了我能够投资标的的波动率

  如果我只能接受单个仓位最大5\%的亏损，那么显然日内价格波动达到5\%以上的投资标的就不适合我。因为短期的波动会很快导致止损平仓，从而错过一波涨势。

2. 任何一笔投资都围绕损失展开

  损失意味着判断失误，判断失误的交易必然造成亏损。亏损是这笔交易的必然结果。因此，即便我有十足的把握这笔交易能盈利，我也无法回避这样的问题：万一我错了，那么后果是否可以挽回。显然一次亏掉一半本金是我以及大多数人不能接受的，尤其是缺乏对市场准确判断的信心时。

简单说，凯利公式最大化盈利期望时，也最大化了策略风险。原版凯利公式在任何情况下输掉，都只会损失全部本金。而扩展凯利公式引入了比例止损线，导致了放大投资额$f$时，损失风险也被放大。扩展的凯利公式并不能提供更好的风险收益比。想象自己的持仓上涨从而追高重仓的时候，大家往往也忽略了潜在的风险。随着价格的上涨，风险愈加升高，而现在收益愈加降低。

凯利公式的启示意义在于回撤风险才是决定仓位的最重要因素，而非期望收益。